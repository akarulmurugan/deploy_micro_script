<!DOCTYPE html>
<html>
<head>
    <title>WIDS Dashboard - Auto-Blocking</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0f172a; color: #f1f5f9; }
        
        .header { background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); 
                 padding: 20px; border-bottom: 3px solid #3b82f6; }
        .header h1 { font-size: 28px; margin-bottom: 5px; }
        .header p { color: #94a3b8; font-size: 14px; }
        
        .stats { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; padding: 20px; }
        .stat-card { background: #1e293b; padding: 20px; border-radius: 10px; border-left: 4px solid #3b82f6; }
        .stat-card.red { border-left-color: #ef4444; }
        .stat-card.green { border-left-color: #10b981; }
        .stat-card.yellow { border-left-color: #f59e0b; }
        .stat-card.purple { border-left-color: #8b5cf6; }
        .stat-card h3 { font-size: 32px; color: #60a5fa; margin-bottom: 5px; }
        .stat-card.red h3 { color: #f87171; }
        .stat-card.green h3 { color: #34d399; }
        .stat-card.yellow h3 { color: #fbbf24; }
        .stat-card.purple h3 { color: #c084fc; }
        .stat-card p { color: #94a3b8; font-size: 14px; }
        
        .tabs { display: flex; background: #1e293b; margin: 0 20px; border-radius: 10px 10px 0 0; overflow: hidden; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab.active { background: #334155; border-bottom-color: #3b82f6; }
        .tab:hover { background: #2d3748; }
        
        .main-content { padding: 0 20px 20px; }
        .tab-content { display: none; background: #1e293b; border-radius: 0 0 10px 10px; overflow: hidden; }
        .tab-content.active { display: block; }
        
        .panel-header { background: #334155; padding: 15px; border-bottom: 1px solid #475569; display: flex; justify-content: space-between; align-items: center; }
        .panel-header h3 { font-size: 18px; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #334155; padding: 12px 15px; text-align: left; font-size: 14px; color: #cbd5e1; }
        td { padding: 12px 15px; border-bottom: 1px solid #334155; }
        tr:hover { background: #2d3748; }
        
        .btn { border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin: 2px; }
        .btn-block { background: #ef4444; color: white; }
        .btn-unblock { background: #10b981; color: white; }
        .btn-authorize { background: #3b82f6; color: white; }
        .btn-unauthorize { background: #f59e0b; color: white; }
        .btn-refresh { background: #8b5cf6; color: white; }
        .btn-test { background: #ec4899; color: white; }
        
        .status { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; display: inline-block; }
        .status-authorized { background: #10b98120; color: #10b981; }
        .status-unauthorized { background: #f59e0b20; color: #f59e0b; }
        .status-blocked { background: #ef444420; color: #ef4444; }
        .status-active { background: #3b82f620; color: #3b82f6; }
        .status-probe { background: #8b5cf620; color: #8b5cf6; }
        
        .log-entry { padding: 10px 15px; border-bottom: 1px solid #334155; font-size: 13px; }
        .log-entry.info { background: #3b82f610; border-left: 3px solid #3b82f6; }
        .log-entry.success { background: #10b98110; border-left: 3px solid #10b981; }
        .log-entry.warning { background: #f59e0b10; border-left: 3px solid #f59e0b; }
        .log-entry.error { background: #ef444410; border-left: 3px solid #ef4444; }
        .log-time { color: #94a3b8; font-size: 12px; }
        .log-message { margin-top: 3px; }
        
        .form-group { padding: 15px; }
        .form-input { width: 100%; padding: 10px; background: #334155; border: 1px solid #475569; border-radius: 4px; color: white; margin-bottom: 10px; }
        .form-label { display: block; margin-bottom: 5px; color: #cbd5e1; }
        
        .footer { text-align: center; padding: 15px; color: #64748b; font-size: 12px; border-top: 1px solid #334155; margin-top: 20px; }
        
        .refresh-btn { background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 10px; }
        
        .test-section { background: #1e293b; padding: 20px; margin: 20px; border-radius: 10px; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; }
        
        .alert { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .alert-success { background: #10b98120; color: #10b981; border: 1px solid #10b981; }
        .alert-error { background: #ef444420; color: #ef4444; border: 1px solid #ef4444; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üì° WIDS Dashboard - Auto-Blocking</h1>
        <p>Wireless Intrusion Detection System | Real-time Monitoring & Auto-Blocking</p>
        <p>Protecting SSID: <strong>{{ your_ssid }}</strong></p>
        <button class="refresh-btn" onclick="loadAllData()">üîÑ Refresh All</button>
        <button class="btn btn-test" onclick="testEmail()">üìß Test Email</button>
    </div>
    
    <div class="stats">
        <div class="stat-card">
            <h3 id="totalDevices">0</h3>
            <p>Devices Detected</p>
        </div>
        <div class="stat-card">
            <h3 id="totalPackets">0</h3>
            <p>Packets Received</p>
        </div>
        <div class="stat-card green">
            <h3 id="authorizedDevices">0</h3>
            <p>Authorized</p>
        </div>
        <div class="stat-card yellow">
            <h3 id="unauthorizedDevices">0</h3>
            <p>Unauthorized</p>
        </div>
        <div class="stat-card red">
            <h3 id="blockedDevices">0</h3>
            <p>Blocked</p>
        </div>
    </div>
    
    <!-- Test Section -->
    <div class="test-section">
        <h3>üì° Manual Test Packet</h3>
        <div class="grid-2">
            <div>
                <input type="text" id="testMac" class="form-input" placeholder="MAC (AA:BB:CC:DD:EE:FF)" value="AA:BB:CC:DD:EE:99">
                <input type="text" id="testSSID" class="form-input" placeholder="SSID" value="{{ your_ssid }}">
            </div>
            <div>
                <select id="testAttackType" class="form-input">
                    <option value="probe_request">Probe Request</option>
                    <option value="auth_attempt">Authentication Attempt</option>
                    <option value="association">Association Request</option>
                    <option value="deauth_attack">Deauth Attack</option>
                </select>
                <input type="number" id="testRSSI" class="form-input" placeholder="RSSI" value="-65">
            </div>
        </div>
        <button class="btn btn-authorize" onclick="sendTestPacket()">üì§ Send Test Packet</button>
        <span id="testResult" style="margin-left: 10px;"></span>
    </div>
    
    <div class="tabs">
        <div class="tab active" onclick="switchTab('devices')">üì± Devices</div>
        <div class="tab" onclick="switchTab('authorized')">‚úÖ Authorized MACs</div>
        <div class="tab" onclick="switchTab('blocked')">üö´ Blocked Devices</div>
        <div class="tab" onclick="switchTab('threats')">‚ö†Ô∏è Threat Log</div>
        <div class="tab" onclick="switchTab('packets')">üì¶ Packets</div>
    </div>
    
    <div class="main-content">
        <!-- Devices Tab -->
        <div id="tab-devices" class="tab-content active">
            <div class="panel-header">
                <h3>Detected Devices (Last Hour)</h3>
                <button class="btn btn-refresh" onclick="loadDevices()">üîÑ Refresh</button>
            </div>
            <div style="overflow-x: auto; max-height: 400px;">
                <table>
                    <thead>
                        <tr>
                            <th>MAC Address</th>
                            <th>Signal</th>
                            <th>Channel</th>
                            <th>Packets</th>
                            <th>Attack Types</th>
                            <th>Last Seen</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="deviceTable">
                        <tr><td colspan="8" style="text-align: center; padding: 20px;">Loading devices...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Authorized MACs Tab -->
        <div id="tab-authorized" class="tab-content">
            <div class="panel-header">
                <h3>Authorized MAC Addresses</h3>
                <button class="btn btn-refresh" onclick="loadAuthorized()">üîÑ Refresh</button>
            </div>
            <div class="form-group">
                <input type="text" id="newMac" class="form-input" placeholder="Enter MAC (AA:BB:CC:DD:EE:FF)">
                <button class="btn btn-authorize" onclick="addAuthorizedMac()">‚ûï Add Authorized MAC</button>
            </div>
            <div style="overflow-x: auto; max-height: 300px;">
                <table>
                    <thead>
                        <tr>
                            <th>MAC Address</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="authorizedTable">
                        <tr><td colspan="3" style="text-align: center; padding: 20px;">Loading authorized MACs...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Blocked Devices Tab -->
        <div id="tab-blocked" class="tab-content">
            <div class="panel-header">
                <h3>Blocked Devices</h3>
                <button class="btn btn-refresh" onclick="loadBlocked()">üîÑ Refresh</button>
            </div>
            <div style="overflow-x: auto; max-height: 400px;">
                <table>
                    <thead>
                        <tr>
                            <th>MAC Address</th>
                            <th>Reason</th>
                            <th>Blocked At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="blockedTable">
                        <tr><td colspan="4" style="text-align: center; padding: 20px;">Loading blocked devices...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Threat Log Tab -->
        <div id="tab-threats" class="tab-content">
            <div class="panel-header">
                <h3>Recent Threats</h3>
                <button class="btn btn-refresh" onclick="loadThreats()">üîÑ Refresh</button>
            </div>
            <div id="threatLog" style="max-height: 500px; overflow-y: auto; padding: 15px;"></div>
        </div>
        
        <!-- Packets Tab -->
        <div id="tab-packets" class="tab-content">
            <div class="panel-header">
                <h3>Recent Packets</h3>
                <button class="btn btn-refresh" onclick="loadPackets()">üîÑ Refresh</button>
            </div>
            <div id="packetLog" style="max-height: 500px; overflow-y: auto; padding: 15px;"></div>
        </div>
    </div>
    
    <div class="footer">
        <p>WIDS Auto-Blocking System | Server: {{ server_ip }}:{{ server_port }} | Last Update: <span id="lastUpdate">--:--:--</span></p>
    </div>
    
    <script>
        // Global variables
        let currentTab = 'devices';
        let updateTimer;
        
        // ========== TAB SWITCHING ==========
        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Load tab data
            loadTabData(tabName);
        }
        
        // ========== LOAD FUNCTIONS ==========
        async function loadAllData() {
            await loadStats();
            await loadTabData(currentTab);
            updateLastUpdate();
        }
        
        async function loadTabData(tabName) {
            switch(tabName) {
                case 'devices': await loadDevices(); break;
                case 'authorized': await loadAuthorized(); break;
                case 'blocked': await loadBlocked(); break;
                case 'threats': await loadThreats(); break;
                case 'packets': await loadPackets(); break;
            }
        }
        
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                document.getElementById('totalDevices').textContent = stats.total_devices || 0;
                document.getElementById('totalPackets').textContent = stats.total_packets || 0;
                document.getElementById('authorizedDevices').textContent = stats.authorized_devices || 0;
                document.getElementById('unauthorizedDevices').textContent = stats.unauthorized_devices || 0;
                document.getElementById('blockedDevices').textContent = stats.blocked_devices || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        async function loadDevices() {
            try {
                const response = await fetch('/api/devices');
                const devices = await response.json();
                
                const tbody = document.getElementById('deviceTable');
                
                if (devices.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">No devices detected</td></tr>';
                    return;
                }
                
                tbody.innerHTML = '';
                
                devices.forEach(device => {
                    const row = tbody.insertRow();
                    
                    const lastSeen = new Date(device.last_seen).toLocaleTimeString();
                    const attackTypes = device.attack_types.join(', ') || 'none';
                    
                    let statusClass = device.authorized ? 'status-authorized' : 'status-unauthorized';
                    let statusText = device.authorized ? 'AUTHORIZED' : 'UNAUTHORIZED';
                    
                    if (device.blocked) {
                        statusClass = 'status-blocked';
                        statusText = 'BLOCKED';
                    }
                    
                    row.innerHTML = `
                        <td><code>${device.mac}</code></td>
                        <td>${device.rssi} dBm</td>
                        <td>${device.channel}</td>
                        <td>${device.packet_count}</td>
                        <td><span class="status status-probe">${attackTypes}</span></td>
                        <td>${lastSeen}</td>
                        <td><span class="status ${statusClass}">${statusText}</span></td>
                        <td>
                            ${!device.authorized ? 
                                `<button class="btn btn-authorize" onclick="authorizeMac('${device.mac}')">Auth</button>` : 
                                `<button class="btn btn-unauthorize" onclick="unauthorizeMac('${device.mac}')">Unauth</button>`
                            }
                            ${!device.blocked ? 
                                `<button class="btn btn-block" onclick="blockMac('${device.mac}')">Block</button>` : 
                                `<button class="btn btn-unblock" onclick="unblockMac('${device.mac}')">Unblock</button>`
                            }
                        </td>
                    `;
                });
                
            } catch (error) {
                console.error('Error loading devices:', error);
                document.getElementById('deviceTable').innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 20px; color: #ef4444;">Error loading devices: ${error.message}</td></tr>`;
            }
        }
        
        async function loadAuthorized() {
            try {
                const response = await fetch('/api/authorized');
                const authorized = await response.json();
                
                const tbody = document.getElementById('authorizedTable');
                
                if (authorized.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px;">No authorized MACs</td></tr>';
                    return;
                }
                
                tbody.innerHTML = '';
                
                authorized.forEach(item => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td><code>${item.mac}</code></td>
                        <td><span class="status status-authorized">AUTHORIZED</span></td>
                        <td>
                            <button class="btn btn-unauthorize" onclick="unauthorizeMac('${item.mac}')">Remove</button>
                        </td>
                    `;
                });
                
            } catch (error) {
                console.error('Error loading authorized:', error);
                document.getElementById('authorizedTable').innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 20px; color: #ef4444;">Error loading authorized MACs</td></tr>`;
            }
        }
        
        async function loadBlocked() {
            try {
                const response = await fetch('/api/blocked');
                const blocked = await response.json();
                
                const tbody = document.getElementById('blockedTable');
                
                if (blocked.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">No blocked devices</td></tr>';
                    return;
                }
                
                tbody.innerHTML = '';
                
                blocked.forEach(device => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td><code>${device.mac}</code></td>
                        <td>${device.reason}</td>
                        <td>${new Date(device.blocked_at).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-unblock" onclick="unblockMac('${device.mac}')">Unblock</button>
                        </td>
                    `;
                });
                
            } catch (error) {
                console.error('Error loading blocked:', error);
                document.getElementById('blockedTable').innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 20px; color: #ef4444;">Error loading blocked devices</td></tr>`;
            }
        }
        
        async function loadThreats() {
            try {
                const response = await fetch('/api/threats');
                const threats = await response.json();
                
                const logDiv = document.getElementById('threatLog');
                
                if (threats.length === 0) {
                    logDiv.innerHTML = '<div class="log-entry info">No threats detected</div>';
                    return;
                }
                
                logDiv.innerHTML = '';
                
                threats.forEach(threat => {
                    const entry = document.createElement('div');
                    entry.className = `log-entry ${threat.type === 'deauth_attack' ? 'error' : 'warning'}`;
                    entry.innerHTML = `
                        <div class="log-time">${new Date(threat.time).toLocaleTimeString()}</div>
                        <div class="log-message">
                            <strong>${threat.type}</strong> from <code>${threat.mac}</code><br>
                            ${threat.reason} | RSSI: ${threat.rssi}dBm
                        </div>
                    `;
                    logDiv.appendChild(entry);
                });
                
            } catch (error) {
                console.error('Error loading threats:', error);
            }
        }
        
        async function loadPackets() {
            try {
                const response = await fetch('/api/packets');
                const packets = await response.json();
                
                const logDiv = document.getElementById('packetLog');
                
                if (packets.length === 0) {
                    logDiv.innerHTML = '<div class="log-entry info">No packets received</div>';
                    return;
                }
                
                logDiv.innerHTML = '';
                
                packets.forEach(packet => {
                    const entry = document.createElement('div');
                    entry.className = 'log-entry info';
                    entry.innerHTML = `
                        <div class="log-time">${new Date(packet.timestamp).toLocaleTimeString()}</div>
                        <div class="log-message">
                            <code>${packet.mac}</code> | ${packet.attack_type} | ${packet.ssid} | ${packet.rssi}dBm | Ch ${packet.channel}
                        </div>
                    `;
                    logDiv.appendChild(entry);
                });
                
            } catch (error) {
                console.error('Error loading packets:', error);
            }
        }
        
        // ========== ACTION FUNCTIONS ==========
        async function sendTestPacket() {
            const mac = document.getElementById('testMac').value.trim().toUpperCase();
            const ssid = document.getElementById('testSSID').value.trim();
            const attack_type = document.getElementById('testAttackType').value;
            const rssi = parseInt(document.getElementById('testRSSI').value);
            const resultSpan = document.getElementById('testResult');
            
            resultSpan.innerHTML = '‚è≥ Sending...';
            
            try {
                const response = await fetch('/api/packet', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        mac: mac,
                        ssid: ssid,
                        attack_type: attack_type,
                        rssi: rssi,
                        channel: 6,
                        sensor_id: 'manual_test'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultSpan.innerHTML = '‚úÖ Test packet sent';
                    setTimeout(() => { loadAllData(); }, 500);
                } else {
                    resultSpan.innerHTML = `‚ùå Error: ${data.error || 'Unknown'}`;
                }
                
            } catch (error) {
                resultSpan.innerHTML = `‚ùå Error: ${error.message}`;
            }
            
            setTimeout(() => { resultSpan.innerHTML = ''; }, 3000);
        }
        
        async function authorizeMac(mac) {
            try {
                const response = await fetch(`/api/authorize/${mac}`, {method: 'POST'});
                if (response.ok) {
                    await loadAllData();
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        async function unauthorizeMac(mac) {
            try {
                const response = await fetch(`/api/unauthorize/${mac}`, {method: 'POST'});
                if (response.ok) {
                    await loadAllData();
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        async function addAuthorizedMac() {
            const mac = document.getElementById('newMac').value.trim().toUpperCase();
            
            if (!mac.match(/^([0-9A-F]{2}:){5}[0-9A-F]{2}$/)) {
                alert('Invalid MAC format. Use AA:BB:CC:DD:EE:FF');
                return;
            }
            
            try {
                const response = await fetch(`/api/authorize/${mac}`, {method: 'POST'});
                if (response.ok) {
                    document.getElementById('newMac').value = '';
                    await loadAuthorized();
                    await loadDevices();
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        async function blockMac(mac) {
            try {
                const response = await fetch(`/api/block/${mac}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({reason: 'manual_block'})
                });
                
                if (response.ok) {
                    await loadAllData();
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        async function unblockMac(mac) {
            try {
                const response = await fetch(`/api/unblock/${mac}`, {method: 'POST'});
                if (response.ok) {
                    await loadAllData();
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        async function testEmail() {
            try {
                const response = await fetch('/api/test_email', {method: 'POST'});
                const result = await response.json();
                alert(result.message || result.error || 'Test email sent');
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        // ========== UTILITY FUNCTIONS ==========
        function updateLastUpdate() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }
        
        // ========== AUTO-REFRESH ==========
        setInterval(() => {
            loadStats();
            if (currentTab === 'devices') loadDevices();
            if (currentTab === 'threats') loadThreats();
            if (currentTab === 'packets') loadPackets();
            updateLastUpdate();
        }, 5000);
        
        // ========== INITIAL LOAD ==========
        window.onload = function() {
            loadAllData();
        };
    </script>
</body>
</html>
